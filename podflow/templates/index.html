<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Podflow</title>
  <style>
    /* å®šä¹‰é¢œè‰²å˜é‡ - æµ…è‰²æ¨¡å¼ */
    :root {
      --bg-color: #f8f9fa;
      --text-color: #333333;
      --secondary-text: #666666;
      --input-bg: #ffffff;
      --input-border: #cccccc;
      --button-bg: #007bff;
      --button-hover: #0056b3;
      --button-text: #ffffff;
      --button-shadow: hsla(0, 0%, 0%, 0.20);
      --menu-bg: #f0f0f0;
      --menu-text: #333333;
      --menu-width: 170px;
      --menu-selected-bg: #cccccc;
      /* å°†è¿›åº¦æ¡é¢œè‰²å˜é‡ä¿®æ”¹ä¸ºè“è‰² */
      --progress-bar-color: #0d6efd; /* æ ‡å‡†è“è‰² */
      --background-bar-color: #e0e0e0; /* æµ…è‰²èƒŒæ™¯ä¸‹çš„è¿›åº¦æ¡é¢œè‰² */
    }

    /* æ·±è‰²æ¨¡å¼å˜é‡ */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #222222;
        --text-color: #e0e0e0;
        --secondary-text: #aaaaaa;
        --input-bg: #333333;
        --input-border: #555555;
        --button-bg: #0062cc;
        --button-hover: #0069d9;
        --button-text: #f0f0f0;
        --button-shadow: hsla(0, 0%, 0%, 0.40);
        --menu-bg: #333333;
        --menu-text: #e0e0e0;
        --menu-selected-bg: #555555;
        /* å°†æ·±è‰²æ¨¡å¼ä¸‹çš„è¿›åº¦æ¡é¢œè‰²ä¿®æ”¹ä¸ºè¾ƒäº®çš„è“è‰² */
        --progress-bar-color: #315188; /* è¾ƒäº®çš„è“è‰²ï¼Œé€‚åˆæ·±è‰²èƒŒæ™¯ */
        --background-bar-color: #333333; /* æ·±è‰²èƒŒæ™¯ä¸‹çš„è¿›åº¦æ¡é¢œè‰² */
      }
    }

    .ansi-url{
      color: #4064a0;
      text-decoration: underline;
    }

    /* ... (å…¶ä½™çš„ ANSI é¢œè‰²ã€åŸºæœ¬æ ·å¼ã€è¡¨å•æ ·å¼ã€æŒ‰é’®æ ·å¼ã€æç¤ºæ ·å¼ã€èœå•åˆ‡æ¢æŒ‰é’®ã€æ‰‹æœºç«¯ä¼˜åŒ–ã€æ¶ˆæ¯å’ŒäºŒç»´ç æ ·å¼ä¿æŒä¸å˜) ... */
    .ansi-30m { color: #000000; }
    .ansi-31m { color: #bb271b; }
    .ansi-32m { color: #61992e; }
    .ansi-33m { color: #bea235; }
    .ansi-34m { color: #4064a0; }
    .ansi-35m { color: #705278; }
    .ansi-36m { color: #449598; }
    .ansi-37m { color: #d4d7d0; }
    .ansi-90m { color: #565752; }
    .ansi-91m { color: #dc3f36; }
    .ansi-92m { color: #53b739; }
    .ansi-93m { color: #f9ea6b; }
    .ansi-94m { color: #7c9ecb; }
    .ansi-95m { color: #de30c5; }
    .ansi-96m { color: #51b2bb; }
    .ansi-97m { color: #eeeeec; }

    @media (prefers-color-scheme: dark) {
      .ansi-30m { color: #ffffff; }
      .ansi-31m { color: #bb271b; }
      .ansi-32m { color: #61992e; }
      .ansi-33m { color: #bea235; }
      .ansi-34m { color: #4064a0; }
      .ansi-35m { color: #705278; }
      .ansi-36m { color: #449598; }
      .ansi-37m { color: #d4d7d0; }
      .ansi-90m { color: #565752; }
      .ansi-91m { color: #dc3f36; }
      .ansi-92m { color: #53b739; }
      .ansi-93m { color: #f9ea6b; }
      .ansi-94m { color: #7c9ecb; }
      .ansi-95m { color: #de30c5; }
      .ansi-96m { color: #51b2bb; }
      .ansi-97m { color: #eeeeec; }
    }

    /* åŸºæœ¬æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
      display: flex;
    }
    nav {
      width: var(--menu-width);
      background-color: var(--menu-bg);
      color: var(--menu-text);
      height: 100vh;
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: width 0.3s, padding 0.3s, color 0.3s;
    }
    nav.hidden {
      width: 0;
      padding: 0;
      overflow: hidden;
    }
    nav ul {
      list-style: none;
      padding: 0;
    }
    nav h3 {
      text-align: center;
      margin: 20px 0 0;
      font-size: 20px;
    }
    nav li {
      margin: 5px 0;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      padding: 0 20px;
      height: 40px;
      line-height: 40px;
    }
    nav li:hover {
      background-color: var(--menu-selected-bg);
      color: var(--button-hover);
    }
    main {
      flex: 1;
      padding: 40px;
      max-width: 520px;
      transition: margin-left 0.3s;
    }
    main.full {
      margin-left: 0;
    }

    /* è¡¨å•ä¸æ¶ˆæ¯åŒºåŸŸå…±ç”¨æ ·å¼ */
    .common-area {
      width: 100%;
      max-width: 520px;
      padding: 0 8px;
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      box-sizing: border-box;
      line-height: 1.1;
      overflow-x: auto; /* å½“å†…å®¹è¶…å‡ºå®½åº¦æ—¶æ˜¾ç¤ºæ°´å¹³æ»šåŠ¨æ¡ï¼ˆå¯é€‰ï¼‰ */
      overflow-y: auto;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå¹¶å…è®¸è‡ªåŠ¨æ¢è¡Œ */
    }
    textarea {
      height: 250px;
      font-size: 16px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background-color: var(--input-bg);
      font-family: 'Courier New', Courier, monospace; /* æ·»åŠ å­—ä½“ */
    }
    #messageDownload {
      max-height: 180px;
      max-width: 99%;
      height: auto;  
      border: 0px;
      border-radius: 4px;
      background-color: var(--bg-color);
    }
    #messageArea {
      height: 250px;
      font-size: 12px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background-color: var(--input-bg);
      font-family: 'Courier New', Courier, monospace; /* æ·»åŠ å­—ä½“ */
    }
    #messageHttp {
      height: 100px;
      font-size: 12px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background-color: var(--input-bg);
      font-family: 'Courier New', Courier, monospace; /* æ·»åŠ å­—ä½“ */
    }
    .button-container {
      margin-top: 10px;
      display: flex;
      justify-content: center; /* æ°´å¹³å±…ä¸­ */
      flex-wrap: wrap; /* æ¢è¡Œ */
      gap: 10px; /* æŒ‰é’®é—´è· */
    }
    button {
      background-color: var(--button-bg);
      color: var(--button-text);
      border: none;
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
      box-shadow: 2px 2px 8px var(--button-shadow);
      margin: 5px;
    }
    button:hover {
      background-color: var(--button-hover);
    }
    .hint {
      font-size: 14px;
      color: var(--secondary-text);
      margin-top: 10px;
    }
    /* èœå•åˆ‡æ¢æŒ‰é’® */
    #toggleMenu {
      width: 35px;
      height: 40px;
      position: fixed;
      left: var(--menu-width);
      top: 5px;
      background: var(--menu-bg);
      border: none;
      font-size: 20px;
      color: var(--text-color);
      cursor: pointer;
      transition: left 0.3s, color 0.3s;
      border-radius: 0 10px 10px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0px 0px 8px var(--button-shadow);
      margin: 0;
    }
    #toggleMenu:hover {
      color: var(--button-hover);
    }

    /* æ‰‹æœºç«¯ä¼˜åŒ– */
    @media (max-width: 600px) {
      #messageArea, textarea {
        max-width: none;
      }
      button {
        width: 90%;
      }
      nav {
        position: fixed;
      }
      /* ç¡®ä¿é¡µé¢å®½åº¦ä¸ä¼šè¶…å‡ºè§†å£ */
      body, html {
        width: 100%;
        overflow-x: hidden;
      }
    }
    .message {
      padding: 0px;
      margin: 0px;
    }

    /* äºŒç»´ç å®¹å™¨æ ·å¼ */
    .qrcode-container {
      display: inline-block; /* è®©å®¹å™¨å¹¶æ’æ˜¾ç¤º */
      margin: 0px;
    }

    .download-container {
      background-color: var(--input-bg);
      border-radius: 25px;
      border: 4px solid var(--input-bg);
      margin: 4px 0; /* ä¸Šä¸‹20pxé—´è·ï¼Œå·¦å³0 */
    }

    /* ä¸»è¿›åº¦æ¡æ ·å¼ */
    #mainProgressBar {
      height: 22px;
      font-weight: bold;
      font-size: 16px;
    }
    .pb-bar {
      max-width: 100%;
      height: 17px;
      background-color: var(--background-bar-color); /* è€ƒè™‘ä½¿ç”¨å˜é‡ */
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid var(--input-border);
      font-size: 11px;
    }
    .pb-progress {
      height: 100%;
      background-color: var(--progress-bar-color);
      width: 0%; /* æ ¹æ®å®é™…è¿›åº¦æ›´æ–° */
      transition: width 0.3s ease-in-out;
      border-radius: 12px;
      /* å¤šèƒŒæ™¯ */
      background-image:
        linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.5) 50%, transparent 100%),
        linear-gradient(to right, rgba(255, 255, 255, 0.15) 0%, rgba(0, 0, 0, 0.15) 100%);
      background-size: 200% 100%, 100% 100%;
      background-repeat: no-repeat, no-repeat;
      /* åˆå§‹èƒŒæ™¯ä½ç½® */
      background-position: 100% 0, 0 0; /* è„‰å†²åˆå§‹åœ¨å·¦ä¾§ */
    }
    /* è„‰å†²åŠ¨ç”»æ•ˆæœ */
    .pb-progress.pb-animated {
      /* åŠ¨ç”»ï¼šåç§° æ—¶é•¿ ç¼“åŠ¨å‡½æ•° å»¶è¿Ÿ æ¬¡æ•° æ–¹å‘ å¡«å……æ¨¡å¼ æ’­æ”¾çŠ¶æ€ */
      animation: pb-pulse-lr 4s linear infinite alternate; /* æ·»åŠ  alternate */
      /* æ³¨æ„ï¼šä½ ä¹Ÿå¯ä»¥è°ƒæ•´æ—¶é•¿ï¼Œä¾‹å¦‚ 2s è®©å•ç¨‹æ›´å¿« */
    }
    /* å…³é”®å¸§åŠ¨ç”» (ä¿æŒ L-to-R å®šä¹‰) */
    @keyframes pb-pulse-lr {
      0% {
        /* è„‰å†²èƒŒæ™¯çš„å³è¾¹ç¼˜å¯¹é½å®¹å™¨å³è¾¹ç¼˜ (é«˜äº®åœ¨å·¦è¾¹ç¼˜) */
        background-position: 100% 0, 0 0;
      }
      100% {
        /* è„‰å†²èƒŒæ™¯çš„å·¦è¾¹ç¼˜å¯¹é½å®¹å™¨å·¦è¾¹ç¼˜ (é«˜äº®åœ¨å³è¾¹ç¼˜) */
        background-position: 0% 0, 0 0;
      }
    }
    .pb-status-text {
      position: absolute;
      top: 50%;
      left: 12px; /* ç¨å¾®è°ƒæ•´å·¦è¾¹è· */
      transform: translateY(-50%);
      color: var(--text-color); /* ä½¿ç”¨æ–‡æœ¬é¢œè‰²å˜é‡ */
      z-index: 2; /* ç¡®ä¿çŠ¶æ€æ–‡æœ¬è¦†ç›–åœ¨è¿›åº¦æ¡ä¸Š */
    }
    .pb-percentage-text {
      position: absolute;
      top: 50%;
      right: 12px; /* ç¨å¾®è°ƒæ•´å³è¾¹è· */
      transform: translateY(-50%);
      color: var(--text-color); /* ä½¿ç”¨æ–‡æœ¬é¢œè‰²å˜é‡ */
      z-index: 2; /* ç¡®ä¿ç™¾åˆ†æ¯”æ–‡æœ¬è¦†ç›–åœ¨è¿›åº¦æ¡ä¸Š */
    }

    /* æ–‡å­—æ»šåŠ¨æ ·å¼æ ·å¼ */
    .scroll {
      display: flex;
      width: 100%;
      height: 14px;
      gap: 20px;
    }
    .scroll-suffix {
      font-size: 7px;
      color: var(--text-color);
      margin-left: auto;
      flex-shrink: 0;
      align-self: flex-end;
    }
    .scroll-container {
      flex: 1; /* è‡ªé€‚åº”å®½åº¦ */
      max-width: 300px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
      font-size: 14px;
      color: var(--text-color);
      line-height: 14px;
      overflow: hidden;
    }
    .scroll-content {
      display: inline-flex;
      white-space: nowrap;
    }
    .scroll-text {
      padding-right: 20px;
    }
    /* åªæœ‰åŠ äº†scrollingç±»æ‰åŠ¨ç”» */
    .scroll-content.scrolling {
      animation: marquee linear infinite;
    }
    @keyframes marquee {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-50%);
      }
    }
    .speed-text {
      font-size: 14px;
      line-height: 14px;
      padding-left: 12px; /* å‘å·¦åç§» 10px */
      flex-shrink: 0;
    }
    .time-text {
      font-size: 14px;
      line-height: 14px;
      padding-right: 12px; /* å‘å³åç§» 10px */
      flex-shrink: 0;
      margin-left: auto;
      align-self: flex-end;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <!-- èœå•æ  -->
  <nav id="menu">
    <h3>èœå•æ </h3>
    <ul>
      <li data-page="pageMessage">Podflow è¿è¡Œæƒ…å†µ</li>
      <li data-page="pageChannel">è·å–åª’ä½“é¢‘é“ ID</li>
    </ul>
  </nav>
  <!-- èœå•åˆ‡æ¢æŒ‰é’® -->
  <button id="toggleMenu">â®</button>
  <!-- ä¸»ä½“åŒºåŸŸ -->
  <main id="main">
    <!-- è·å– Channel-ID é¡µé¢ -->
    <section id="pageChannel" style="display: none;">
      <h2>è·å–åª’ä½“é¢‘é“ ID</h2>
      <form id="inputForm" method="post" action="getid">
        <label for="inputOutput">è¯·è¾“å…¥ï¼š</label><br>
        <textarea class="common-area" name="inputOutput" id="inputOutput"></textarea><br>
        <div class="button-container">
          <button type="button" id="pasteBtn">ğŸ“‹ ç²˜è´´</button>
          <button type="submit">âœ… æäº¤</button>
          <button type="button" id="copyBtn">ğŸ“„ æ‹·è´</button>
          <button type="button" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        <p class="hint">ğŸ“Œ å¦‚æœç²˜è´´æŒ‰é’®æ— æ•ˆï¼Œè¯·é•¿æŒ‰è¾“å…¥æ¡†æ‰‹åŠ¨ç²˜è´´ã€‚</p>
      </form>
    </section>
    <!-- æ¶ˆæ¯æ»šåŠ¨æ˜¾ç¤ºé¡µé¢ -->
    <section id="pageMessage">
      <h2>Podflow è¿è¡Œæƒ…å†µ</h2>
      <form>
        <label>ä¸»è¿›åº¦æ¡ï¼š</label><br>
        <div class="pb-bar" id="mainProgressBar">
          <div class="pb-progress pb-animated" id="mainProgress"></div>
          <div class="pb-status-text" id="progressStatus">å‡†å¤‡ä¸­</div>
          <div class="pb-percentage-text" id="progressPercentage">0.00%</div>
        </div>
        <label id="downloadLabel"></label><br>
        <div class="common-area" id="messageDownload"></div>
        <label>æ„å»ºæœåŠ¡ï¼š</label><br>
        <div class="common-area" id="messageArea"></div>
        <label>æ”¶å‘æœåŠ¡ï¼š</label><br>
        <div class="common-area" id="messageHttp"></div>
      </form>
    </section>
  </main>
  <script>
    (function() {
      // ç¼“å­˜å¸¸ç”¨èŠ‚ç‚¹
      const menu = document.getElementById('menu');
      const toggleMenuBtn = document.getElementById('toggleMenu');
      const pages = {
        pageChannel: document.getElementById('pageChannel'),
        pageMessage: document.getElementById('pageMessage')
      };
      const inputForm = document.getElementById('inputForm');
      const inputOutput = document.getElementById('inputOutput');
      const pasteBtn = document.getElementById('pasteBtn');
      const copyBtn = document.getElementById('copyBtn');
      const clearBtn = document.getElementById('clearBtn');
      // ç¼“å­˜è¿›åº¦æ¡å’Œæ–‡æœ¬å…ƒç´ 
      const mainProgress = document.getElementById('mainProgress');
      const progressStatus = document.getElementById('progressStatus');
      const progressPercentage = document.getElementById('progressPercentage');
      const messageArea = document.getElementById('messageArea');
      const messageHttp = document.getElementById('messageHttp');
      const messageDownload = document.getElementById('messageDownload');
    
      let lastMessage = { podflow: [], http: [], schedule: [], download: [] };
      let pollingTimer = null;
      let userScrolled = false;
      
      // ç”Ÿæˆå•ä¸ªäºŒç»´ç çš„å‡½æ•°
      function generateQRCodeForNode(container) {
        const rootStyles = getComputedStyle(document.documentElement);
        const textColor = rootStyles.getPropertyValue('--text-color').trim();
        const inputBg = rootStyles.getPropertyValue('--input-bg').trim();
        const url = container.dataset.url;
        container.innerHTML = '';
        if (url) {
          new QRCode(container, {
            text: url,
            width: 220,
            height: 220,
            colorDark: textColor,
            colorLight: inputBg,
            correctLevel: QRCode.CorrectLevel.L
          });
        } else {
          container.textContent = 'URL æœªæä¾›';
        }
      }
    
      // èœå•åˆ‡æ¢å‡½æ•°
      function toggleMenu() {
        menu.classList.toggle('hidden');
        if (menu.classList.contains('hidden')) {
          toggleMenuBtn.style.left = '0px';
          toggleMenuBtn.textContent = 'â¯';
        } else {
          toggleMenuBtn.style.left = 'var(--menu-width)';
          toggleMenuBtn.textContent = 'â®';
        }
      }
    
      // æ ¹æ®é¡µé¢æ ‡è¯†æ˜¾ç¤ºå¯¹åº”é¢æ¿
      function showPage(pageId) {
        Object.values(pages).forEach(page => page.style.display = 'none');
        if (pages[pageId]) {
          pages[pageId].style.display = 'block';
          // æ‰‹æœºæ¨¡å¼ä¸‹è‡ªåŠ¨éšè—èœå•
          if (window.innerWidth <= 600 && !menu.classList.contains('hidden')) {
            toggleMenu();
          }
          if (pageId === 'pageMessage') {
            startMessage();
          } else {
            stopMessage();
          }
        }
      }
    
      // ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ£€æµ‹ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ»šåŠ¨
      function onUserScroll(event) {
        const element = event.target;
        // åˆ¤æ–­æ˜¯å¦æ¥è¿‘åº•éƒ¨ï¼Œå¢åŠ ä¸€å®šçš„å®¹å·®å€¼
        const nearBottom = element.scrollHeight - element.scrollTop <= element.clientHeight + 10;
        userScrolled = !nearBottom;
      }

      // è½®è¯¢æ¶ˆæ¯æ›´æ–°ï¼Œæ›´æ–° messageArea ä¸ messageHttp
      function getMessages() {
        fetch('message')
          .then(response => response.json()) // è§£æ JSON æ•°æ®
          .then(data => {
            if (JSON.stringify(data) !== JSON.stringify(lastMessage)) {
              // æ›´æ–°è¿›åº¦æ¡
              updateProgress(data.schedule);
              // è¿½åŠ æ–°æ¶ˆæ¯
              appendMessages(messageArea, data.podflow, lastMessage.podflow);
              appendMessages(messageHttp, data.http, lastMessage.http);
              appendBar(messageDownload, data.download, lastMessage.download);
              lastMessage = data;
            }
          })
          .catch(error => console.error('è·å–æ¶ˆæ¯å¤±è´¥:', error));
      }
      
      // æ›´æ–°è¿›åº¦æ¡å¹¶æ˜¾ç¤ºçŠ¶æ€å’Œç™¾åˆ†æ¯”
      function updateProgress(scheduleData) {
        // æ£€æŸ¥ schedule æ•°æ®æ˜¯å¦å­˜åœ¨ä¸”é•¿åº¦ä¸º 2
        if (scheduleData && scheduleData.length === 2) {
          const [status, progress] = scheduleData; // ç›´æ¥è§£æ„æ•°ç»„
          if (status === "å‡†å¤‡ä¸­" || status === "æ„å»ºä¸­") {
            mainProgress.style.width = `${progress * 100}%`;
            progressStatus.textContent = status;   // æ˜¾ç¤ºçŠ¶æ€
            progressPercentage.textContent = `${(progress * 100).toFixed(2)}%`;   // æ˜¾ç¤ºç™¾åˆ†æ¯”ï¼Œä¿ç•™ä¸¤ä½å°æ•°
          } else if (status === "å·²å®Œæˆ") {
            mainProgress.style.width = '100%';
            progressStatus.textContent = 'å·²å®Œæˆ';   // æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
            progressPercentage.textContent = '100.0%';   // æ˜¾ç¤ºç™¾åˆ†æ¯”
          }
        }
      }

      // ä¸‹è½½æ–‡ä»¶è¿›åº¦æ¡
      function addProgressBar(percentageText, time, speed, idname="", nameText="", file="") {
        const download = document.createElement('div');
        download.className = 'download-container';
        const idnameText = document.createElement('div');
        idnameText.className = 'scroll-text';
        idnameText.innerHTML = '  ' + idname;
        const fileInfo = document.createElement('div');
        fileInfo.className = 'scroll';
        const filesuffix = document.createElement('div');
        filesuffix.className = 'scroll-suffix';
        filesuffix.innerHTML = file;
        const scroll = document.createElement('div');
        scroll.className = 'scroll-container';
        const namebar = document.createElement('div');
        namebar.className = 'scroll-content';
        const filename = document.createElement('div');
        filename.className = 'scroll-text';
        filename.innerHTML = nameText;
        namebar.appendChild(filename);
        scroll.appendChild(namebar);
        fileInfo.appendChild(scroll);
        fileInfo.appendChild(filesuffix);
        download.appendChild(idnameText);
        download.appendChild(fileInfo);
        // å»¶è¿Ÿæµ‹é‡æ–‡æœ¬å®½åº¦ï¼Œå†³å®šæ˜¯å¦æ»šåŠ¨
        setTimeout(() => {
          const contentWidth = filename.scrollWidth;  // å•ä»½æ–‡æœ¬å®½åº¦
          const containerWidth = scroll.clientWidth;
          if (contentWidth > containerWidth) {
            // éœ€è¦æ»šåŠ¨ï¼Œæ·»åŠ ç¬¬äºŒä»½æ–‡æœ¬å®ç°æ— ç¼æ»šåŠ¨
            const filename1 = document.createElement('div');
            filename1.className = 'scroll-text';
            filename1.innerHTML = nameText;
            namebar.appendChild(filename1);
            // é‡æ–°è®¡ç®—å®½åº¦ï¼Œè¿™æ¬¡æ˜¯åŒå€å®½åº¦ä¸­çš„å•ä»½å®½åº¦ç”¨äºè®¡ç®—æ—¶é—´
            const singleContentWidth = namebar.scrollWidth / 2;
            // åŠ¨ç”»æ—¶é—´ï¼Œé€Ÿåº¦px/s
            const speed = 30;
            const duration = singleContentWidth / speed;
            namebar.style.animationDuration = duration + 's';
            // --- æ–°å¢ä»£ç ï¼šå»¶è¿Ÿ2ç§’æ·»åŠ æ»šåŠ¨ç±» ---
            // å…ˆè®¾ç½®å¥½åŠ¨ç”»æ—¶é•¿ç­‰å±æ€§ï¼Œä½†ä¸ç«‹å³å¼€å§‹åŠ¨ç”»
            setTimeout(() => {
              namebar.classList.add('scrolling');
            }, 1500);
          } else {
            // ä¸æ»šåŠ¨ï¼Œç¡®ä¿ç§»é™¤åŠ¨ç”»ç±»å’Œæ ·å¼
            namebar.classList.remove('scrolling');
            namebar.style.animationDuration = '';
          }
        }, 0); // åˆå§‹çš„setTimeout(..., 0)æ˜¯ä¸ºäº†ç¡®ä¿å…ƒç´ æ¸²æŸ“å®Œæˆï¼Œå¯ä»¥è·å–æ­£ç¡®å°ºå¯¸
        // è¿›åº¦æ¡éƒ¨åˆ†
        let statusText = '';
        if (percentageText === 0) {
          statusText = 'å‡†å¤‡ä¸­';
        } else if (percentageText === 1) {
          statusText = 'å·²å®Œæˆ';
        } else {
          statusText = 'ä¸‹è½½ä¸­';
        }
        const pbBar = document.createElement('div');
        pbBar.className = 'pb-bar';
        const pbProgress = document.createElement('div');
        pbProgress.className = 'pb-progress pb-animated';
        pbProgress.style.width = `${percentageText * 100}%`;
        const pbStatusText = document.createElement('div');
        pbStatusText.className = 'pb-status-text';
        pbStatusText.innerHTML = statusText;
        const pbPercentageText = document.createElement('div');
        pbPercentageText.className = 'pb-percentage-text';
        pbPercentageText.innerHTML = `${(percentageText * 100).toFixed(2)}%`;
        pbBar.appendChild(pbProgress);
        pbBar.appendChild(pbStatusText);
        pbBar.appendChild(pbPercentageText);
        download.appendChild(pbBar);
        // é€Ÿåº¦éƒ¨åˆ†
        const speedContainer = document.createElement('div');
        speedContainer.className = 'scroll';
        const speedText = document.createElement('div');
        speedText.className = 'speed-text';
        speedText.innerHTML = speed;
        const timeText = document.createElement('div');
        timeText.className = 'time-text';
        timeText.innerHTML = time;
        speedContainer.appendChild(speedText);
        speedContainer.appendChild(timeText);
        download.appendChild(speedContainer);
        return download;
      }
      
      function createMessageElement(message) {
        const div = document.createElement('div');
        div.innerHTML = message;
        div.className = 'message';
        return div;
      }
      
      function processQRCodeContainers(div) {
        const qrContainers = div.querySelectorAll('.qrcode-container');
        qrContainers.forEach(container => {
          // åˆ¤æ–­å½“å‰å®¹å™¨æ˜¯å¦æœ‰ data-url å±æ€§ï¼Œå¹¶ä¸”å€¼ä¸ä¸ºç©º
          if (container.dataset.url) {
            generateQRCodeForNode(container);
          } else {
            // å¦‚æœæ²¡æœ‰ data-url æˆ–å€¼ä¸ºç©ºï¼Œå¯ä»¥æ‰§è¡Œå…¶ä»–æ“ä½œï¼Œä¾‹å¦‚è¾“å‡ºæç¤ºä¿¡æ¯
            console.log('å®¹å™¨ä¸­æœªæä¾› URLï¼Œè·³è¿‡äºŒç»´ç ç”Ÿæˆ:', container);
            container.textContent = 'æœªæä¾›äºŒç»´ç  URL'; // å¯é€‰ï¼šåœ¨å®¹å™¨ä¸­æ˜¾ç¤ºæç¤º
          }
        });
      }
      
      // ä¿®æ”¹åçš„ appendMessages å‡½æ•°ï¼šå…ˆç”Ÿæˆæ¶ˆæ¯èŠ‚ç‚¹å†…çš„äºŒç»´ç ï¼Œå†å°†èŠ‚ç‚¹è¿½åŠ æˆ–æ›¿æ¢åˆ°æ¶ˆæ¯å®¹å™¨ä¸­
      function appendMessages(container, newMessages, oldMessages) {
        // åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨åº•éƒ¨
        const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 10;
        // è¾ƒä¸ºç®€å•çš„æƒ…å†µï¼šä¸¤æ•°ç»„é•¿åº¦ç›¸åŒä¸”æœ‰å†…å®¹ï¼Œåªæ¯”è¾ƒæœ€åå››é¡¹
        if (newMessages.length === oldMessages.length && newMessages.length > 0) {
          let replaceCount;
          if (newMessages[newMessages.length - 1].includes("æœªæ‰«æ") || 
              newMessages[newMessages.length - 1].includes("äºŒç»´ç è¶…æ—¶, è¯·é‡è¯•")) {
            replaceCount = Math.min(4, newMessages.length);
          } else {
            replaceCount = 1;
          }
          for (let i = 0; i < replaceCount; i++) {
            // è®¡ç®—ä»åå‘å‰çš„ç´¢å¼•ä½ç½®
            const index = newMessages.length - 1 - i;
            const newMessage = newMessages[index];
            const oldMessage = oldMessages[index];
            if (newMessage !== oldMessage) {
              // å…ˆåˆ›å»ºæ¶ˆæ¯èŠ‚ç‚¹
              const div = createMessageElement(newMessage);
              // åœ¨æ’å…¥å‰å…ˆå¤„ç†äºŒç»´ç ç”Ÿæˆ
              processQRCodeContainers(div);
              // æ›¿æ¢åˆ°å®¹å™¨ä¸­ - æ³¨æ„è¿™é‡Œè¦æ‰¾åˆ°å¯¹åº”ä½ç½®çš„å­å…ƒç´ 
              const childToReplace = container.children[index];
              if (childToReplace) {
                container.replaceChild(div, childToReplace);
              }
            }
          }
        } else {
          // å½“ newMessages ä¸ oldMessages æ•°é‡ä¸ä¸€è‡´æ—¶
          // å¦‚æœ oldMessages å­˜åœ¨æ•°æ®ï¼Œå…ˆæ›¿æ¢å®¹å™¨ä¸­æœ€åä¸€é¡¹å¯¹åº”çš„æ¶ˆæ¯
          if (oldMessages.length > 0) {
            const replaceIndex = oldMessages.length - 1;
            const div = createMessageElement(newMessages[replaceIndex]);
            // å…ˆç”ŸæˆäºŒç»´ç 
            processQRCodeContainers(div);
            const lastChild = container.lastElementChild;
            if (lastChild) {
              container.replaceChild(div, lastChild);
            } else {
              container.appendChild(div);
            }
          }
          // å†è¿½åŠ ä» oldMessages.length å¼€å§‹çš„åç»­æ¶ˆæ¯
          newMessages.slice(oldMessages.length).forEach(msg => {
            const div = createMessageElement(msg);
            // å…ˆç”ŸæˆäºŒç»´ç 
            processQRCodeContainers(div);
            // æ’å…¥å®¹å™¨ä¸­
            container.appendChild(div);
          });
        }
        // å¦‚æœä¹‹å‰åœ¨åº•éƒ¨ä¸”ç”¨æˆ·æ²¡æœ‰ä¸»åŠ¨æ»šåŠ¨ï¼Œåˆ™è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        if (wasAtBottom && !userScrolled) {
          container.scrollTop = container.scrollHeight;
        }
      }

      function appendBar(container, newMessages, oldMessages) {
        container.innerHTML = '';
        if (newMessages.length > 0) {
          downloadLabel.textContent = 'ä¸‹è½½è¿›åº¦ï¼š';
          for (let i = newMessages.length - 1; i >= 0; i--){
            const messageContent = newMessages[i];
            const [percentageText, time, speed, idname, nameText, file] = messageContent;
            const div = addProgressBar(percentageText, time, speed, idname, nameText, file);
            container.appendChild(div);
          }
        }
      }

      // å¯åŠ¨æ¶ˆæ¯è½®è¯¢
      function startMessage() {
        getMessages();
        pollingTimer = setInterval(getMessages, 800);
      }
    
      // åœæ­¢æ¶ˆæ¯è½®è¯¢
      function stopMessage() {
        if (pollingTimer !== null) {
          clearInterval(pollingTimer);
          pollingTimer = null;
        }
      }
    
      // æ»šåŠ¨äº‹ä»¶ç›‘å¬å™¨
      messageArea.addEventListener('scroll', onUserScroll);
      messageHttp.addEventListener('scroll', onUserScroll);
      messageDownload.addEventListener('scroll', onUserScroll);

      // åˆå§‹åŒ–é»˜è®¤é¡µé¢
      showPage('pageMessage');
    
      // è¡¨å•å¼‚æ­¥æäº¤ï¼ˆè·å– Channel-IDï¼‰
      inputForm && inputForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const content = inputOutput.value;
        fetch('getid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('ç½‘ç»œå“åº”å¼‚å¸¸');
            }
            return response.json();
          })
          .then(data => inputOutput.value = data.response)
          .catch(error => {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼');
          });
      });
    
      // ç²˜è´´åŠŸèƒ½
      pasteBtn.addEventListener('click', function() {
        if (navigator.clipboard && navigator.clipboard.readText) {
          navigator.clipboard.readText().then(text => {
            inputOutput.value = text;
            inputOutput.focus();
          }).catch(err => {
            console.warn("å‰ªè´´æ¿è¯»å–å¤±è´¥:", err);
            alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ï¼");
          });
        } else {
          try {
            inputOutput.focus();
            document.execCommand('paste');
          } catch (err) {
            console.warn("execCommand ç²˜è´´å¤±è´¥:", err);
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨ç²˜è´´ï¼Œè¯·æ‰‹åŠ¨æ“ä½œï¼");
          }
        }
      });
    
      // å¤åˆ¶åŠŸèƒ½
      copyBtn.addEventListener('click', function() {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(inputOutput.value).catch(err => {
            console.warn("å¤åˆ¶å¤±è´¥:", err);
            alert("æ— æ³•å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬åæŒ‰ Ctrl+C å¤åˆ¶ï¼");
          });
        } else {
          try {
            inputOutput.select();
            document.execCommand('copy');
          } catch (err) {
            console.warn("execCommand å¤åˆ¶å¤±è´¥:", err);
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨æ“ä½œï¼");
          }
        }
      });
    
      // æ¸…ç©ºè¾“å…¥æ¡†
      clearBtn.addEventListener('click', function() {
        inputOutput.value = '';
      });
    
      // èœå•é¡¹ç‚¹å‡»äº‹ä»¶å§”æ‰˜
      menu.addEventListener('click', function(event) {
        const target = event.target;
        if (target.tagName.toLowerCase() === 'li' && target.dataset.page) {
          showPage(target.dataset.page);
        }
      });
    
      // èœå•åˆ‡æ¢æŒ‰é’®äº‹ä»¶ç»‘å®š
      toggleMenuBtn.addEventListener('click', toggleMenu);

      // é’ˆå¯¹æ‰‹æœºç«¯ï¼Œåˆå§‹åŒ–æ—¶éšè—èœå•
      if (window.innerWidth <= 600) {
        menu.classList.add('hidden');
        toggleMenuBtn.style.left = '0px';
        toggleMenuBtn.textContent = 'â¯';
      }
    })();
    </script>
</body>
</html>
